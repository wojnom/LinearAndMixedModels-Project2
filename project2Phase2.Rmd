---
title: "Project 2 | Phase 2"
author: "Micha³ Frej, Karolina Gajewska, Agnieszka Sitko, Marcin Wojno"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---
```{r, warning = FALSE, message = FALSE, echo = FALSE}
setwd("~/UniwersytetWarszawski/LinearModels/Project2")
load("~/UniwersytetWarszawski/LinearModels/Project2/dendriticSpines.rda")
library(lme4)
library(lattice)
library(PBImisc)
library(dplyr)
attach(dendriticSpines)
```


##Introduction - dependent variable

In this project we analize data about the length of dendritic spines of mice and its dependence on genotype and five selected types of treatment (including no treatment as a one type). 

Looking at QQ plots of `length` and `log(length)` we have decided to apply logarithmic transformation to the dependent variable, as it provides a distribution closer to normal.

```{r, warning = FALSE, message = FALSE, echo = FALSE}
par(mfrow = c(1,2))
qqnorm(length, main = "QQ plot for length")
qqline(length)
qqnorm(log(length), main = "QQ plot for log(length)")
qqline(log(length))
par(mfrow = c(1,1))
```

##Variables selection

###Mouse type

The following boxplot shows that there are differences in `log(length)` between mouse types.

```{r, warning = FALSE, message = FALSE, echo = FALSE}
bwplot(log(length) ~ mouse)
```

As we have stated in the beginning, we are interested in an influence of mouse genotype on the length of dendritic spines. Thus, we add `mouse` to our model as a fixed effect. 

###Treatment

`log(length)` differs among treatment types (see boxplot below). 

```{r, warning = FALSE, message = FALSE, echo = FALSE}
bwplot(log(length) ~ treatment)
```

Following the same argumentation, we include `treatment` as a fixed effect.

###Interaction between mouse type and treatment

Using the results from the previous phase, we have decided to add interactions between `mouse` and `treatment` to the model. In the first phase we detected significant effect of such interactions in KO study. 

###Animal:Photo_ID_abs

In the dataset variable `Photo_ID_abs` is naturally nested in `Animal` and `Animal` is nested in `Study`.

We cannot exclude from the model `Animal` and `Photo_ID_abs` effects, but, as we are not so interested in an impact of a particular photo or individual, we assume they are random. 


###Study

Data may be groupped by study. Each study contains information collected for two out of three types of mouse and for two out of five types of treatment (including no treatment). Number of observations by study, mouse type and treatment are gathered in a table below.

```{r, warning = FALSE, message = FALSE, echo = FALSE}
table <- matrix(table(Study:mouse:treatment), 15, 3)
colnames(table) <- levels(Study)
row.names(table) <- levels(mouse:treatment)
table
```

As we analyze all three studies (which could have been performed independently), we cannot exclude from our model study effect. The following boxplot gives more reasons to include this effect to the model - dendritic spines of mice from KO study are on average shorter than dendritic spines of mice from other studies.


```{r, warning = FALSE, message = FALSE, echo = FALSE}
bwplot(log(length) ~ Study)
```

However, we are not interested in a effect of a particular study. Therefore, we include `Study` as a random variable. 

We also check if the relation between the fixed variables introduced above and the dependent variable differs between studies. 

(!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!tu by siê przyda³ jakiœ komentarz!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!)

##Creating the model

After those analysis, we can finally run a model. We start with a small model defined by a formula `log(length) ~ mouse + treatment + (mouse + treatment|Study)` (called `addMouseTreatGroupedByStudy`)

```{r, warning = FALSE, message = FALSE, echo = FALSE}
load("~/LinearAndMixedModels-Project2/addMouseTreatGroupedByStudy.RData")
load("~/LinearAndMixedModels-Project2/multiMouseTreatGroupedByStudyWithoutREML.RData")
load("~/LinearAndMixedModels-Project2/PhotoadditiveMouseTreatGroupedByStudy.rda")
load("~/LinearAndMixedModels-Project2/additiveAnimalNestedInStudyWithoutREML.RData")
```

Now we add interaction between `mouse` and `treatment` to the model and check if it is significant.

```{r, warning = FALSE, message = FALSE}
#anova(addMouseTreatGroupedByStudy, multiMouseTreatGroupedByStudyWithoutREML)
```

It turns out that interaction can be ignored.

Next, we include a random varable `Study/Animal` into the model.

```{r, warning = FALSE, message = FALSE}
#anova(addMouseTreatGroupedByStudy, additiveAnimalNestedInStudyWithoutREML)
```



Finally, we add a random variable `Study/Animal/Photo_ID_abs`.

```{r, warning = FALSE, message = FALSE}
#anova(additiveAnimalNestedInStudyWithoutREML, PhotoadditiveMouseTreatGroupedByStudy)
```

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Zak³adam, ¿e najlepszy bêdzie model PhotoadditiveMouseTreatGroupedByStudy!!!!!!!!!!!!!!!
!!!!Trzeba przetestowaæ istotnoœæ efektów sta³ych!!!!!!!!


##Model diagnostics

###Residuals
```{r, warning = FALSE, message = FALSE}
residuals <- fitted.values(PhotoadditiveMouseTreatGroupedByStudy) - log(length)
qqnorm(residuals)
qqline(residuals)
```

So residuals are normally distributed.

###Random effects

```{r, warning = FALSE, message = FALSE}
u <- ranef(PhotoadditiveMouseTreatGroupedByStudy, postVar = TRUE)
qqmath(u)[[1]] #nie wiem czemu, nie dodaj¹ siê przedzia³y ufnoœci...
qqmath(u)[[2]]
```
